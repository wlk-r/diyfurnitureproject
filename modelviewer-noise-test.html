<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Viewer Pixelate Test - diy furniture project</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Import map for Three.js (required by model-viewer-effects) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.166.0/build/three.module.js",
            "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.166.0/examples/jsm/"
        }
    }
    </script>
    <!-- Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <!-- Model Viewer Effects addon -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer-effects/dist/model-viewer-effects.min.js"></script>
    <!-- Protected Model Loader -->
    <script src="model-loader.js" defer></script>

    <style>
        /* Controls panel */
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            border: 1px solid #ccc;
            padding: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            z-index: 10000;
            max-height: 90vh;
            overflow-y: auto;
            width: 200px;
        }
        #controls h3 {
            margin: 0 0 8px 0;
            font-size: 11px;
            font-weight: 500;
        }
        #controls .section-title {
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 4px;
        }
        #controls label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 8px;
        }
        #controls input[type="number"] {
            width: 60px;
            padding: 2px 4px;
            font-family: inherit;
            font-size: 10px;
            border: 1px solid #ccc;
        }
        #controls input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }
        #controls .section {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        #controls button {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            background: #f5f5f5;
            border: 1px solid #ccc;
        }
        #controls button:hover {
            background: #eee;
        }
    </style>
</head>
<body>
    <!-- Controls Panel -->
    <div id="controls">
        <h3>Pixelate Effect Settings</h3>

        <div class="section">
            <div class="section-title">Pixelation</div>
            <label>Start Granularity <input type="number" id="startGranularity" value="100" step="5" min="1"></label>
            <label>End Granularity <input type="number" id="endGranularity" value="0" step="1" min="0"></label>
        </div>

        <div class="section">
            <div class="section-title">Timing</div>
            <label>Duration (s) <input type="number" id="duration" value="5" step="0.5"></label>
            <label>Delay After Load (s) <input type="number" id="fadeDelay" value="0.3" step="0.1"></label>
            <label>Update Rate (ms) <input type="number" id="updateRate" value="50" step="10" min="16"></label>
        </div>

        <div class="section">
            <div class="section-title">Easing</div>
            <label>
                Curve
                <select id="easingCurve" style="width:70px;font-size:10px;">
                    <option value="linear">Linear</option>
                    <option value="easeOut" selected>Ease Out</option>
                    <option value="easeInOut">Ease In-Out</option>
                </select>
            </label>
        </div>

        <button id="resetBtn">Reset All Effects</button>
    </div>

    <div class="page-grid">
        <!-- Left Sidebar: Profile -->
        <aside class="sidebar-left">
            <div class="sidebar-header">diy furniture project</div>
            <hr class="hairline">

            <div class="sidebar-section">
                <p class="sidebar-text">Material and virtual design that seeks to make building durable furniture more accessible.</p>
            </div>

            <div class="sidebar-section">
                <div class="section-label">PAGES</div>
                <a href="main.html" class="sidebar-link">Home</a><br>
                <a href="about.html" class="sidebar-link">About</a><br>
                <a href="suggested-tools.html" class="sidebar-link">Suggested Tools</a><br>
                <a href="faqs.html" class="sidebar-link">FAQs</a>
            </div>

            <div class="sidebar-section">
                <div class="section-label">CONTACT</div>
                <a href="mailto:wnosworthy@gmail.com" class="sidebar-link">wnosworthy@gmail.com</a><br>
                <a href="https://instagram.com/walkernotsoworthy" class="sidebar-link">Instagram</a>
            </div>
        </aside>

        <!-- Main Content: Work Feed -->
        <main class="main-content">
            <div class="models-grid">
                <!-- Products will be loaded here -->
            </div>
        </main>
    </div>

    <script type="module">
    // Easing functions
    const easings = {
        linear: t => t,
        easeOut: t => 1 - Math.pow(1 - t, 3),
        easeInOut: t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2
    };

    // Pixelate effect manager using model-viewer-effects
    const PixelateEffect = {
        instances: [],
        animationIntervals: {},

        getSettings() {
            return {
                startGranularity: parseInt(document.getElementById('startGranularity').value),
                endGranularity: parseInt(document.getElementById('endGranularity').value),
                duration: parseFloat(document.getElementById('duration').value) * 1000,
                fadeDelay: parseFloat(document.getElementById('fadeDelay').value) * 1000,
                updateRate: parseInt(document.getElementById('updateRate').value),
                easingCurve: document.getElementById('easingCurve').value,
            };
        },

        startAnimation(id) {
            const settings = this.getSettings();
            const instance = this.instances.find(i => i.id === id);
            if (!instance) return;

            const { pixelateEffect } = instance;
            instance.active = true;

            // Set initial granularity
            pixelateEffect.setAttribute('granularity', settings.startGranularity);
            pixelateEffect.setAttribute('blend-mode', 'default');

            const startTime = performance.now();
            const startGran = settings.startGranularity;
            const endGran = settings.endGranularity;
            const easing = easings[settings.easingCurve];

            const animate = () => {
                if (!instance.active) return;

                const elapsed = performance.now() - startTime;
                const progress = Math.min(1, elapsed / settings.duration);
                const easedProgress = easing(progress);

                const currentGranularity = Math.round(startGran - (startGran - endGran) * easedProgress);
                pixelateEffect.setAttribute('granularity', currentGranularity);

                if (progress < 1) {
                    this.animationIntervals[id] = setTimeout(animate, settings.updateRate);
                } else {
                    // Animation complete - disable pixelate effect only, keep glitch on
                    pixelateEffect.setAttribute('blend-mode', 'skip');
                    instance.active = false;
                    console.log(`[EFFECT] Model ${id} animation complete`);
                }
            };

            // Start with delay
            setTimeout(animate, settings.fadeDelay);
        },

        stopAnimation(id) {
            if (this.animationIntervals[id]) {
                clearTimeout(this.animationIntervals[id]);
                delete this.animationIntervals[id];
            }
            const instance = this.instances.find(i => i.id === id);
            if (instance) {
                instance.active = false;
            }
        },

        resetAll() {
            // Stop all animations
            this.instances.forEach(({ id }) => {
                this.stopAnimation(id);
            });
            // Clear instances
            this.instances = [];
            this.animationIntervals = {};

            // Reload everything
            loadProductsWithPixelate();
        }
    };

    // Custom product loader for this test page
    async function loadProductsWithPixelate() {
        try {
            const response = await fetch('./products.json');
            if (!response.ok) throw new Error(`Failed to load products: ${response.statusText}`);

            const data = await response.json();
            const products = data.products;
            const grid = document.querySelector('.models-grid');
            if (!grid) return;

            grid.innerHTML = '';
            const settings = PixelateEffect.getSettings();

            products.forEach((product, index) => {
                const article = document.createElement('article');
                article.className = 'model-card';

                article.innerHTML = `
                    <div class="model-viewer-container" id="model-container-${index}">
                        <div class="model-loading-spinner">
                            <svg viewBox="0 0 36 36">
                                <circle class="spinner-track" cx="18" cy="18" r="16"></circle>
                                <circle class="spinner-progress" cx="18" cy="18" r="16"></circle>
                            </svg>
                        </div>
                        <model-viewer
                            id="model-viewer-${index}"
                            data-model="${product.model}"
                            alt="${product.name}"
                            camera-controls
                            disable-zoom
                            disable-pan
                            auto-rotate
                            shadow-intensity="1"
                            exposure="1"
                            tone-mapping="aces"
                            ar>
                            <effect-composer render-mode="quality">
                                <pixelate-effect
                                    id="pixelate-${index}"
                                    blend-mode="default"
                                    granularity="${settings.startGranularity}">
                                </pixelate-effect>
                            </effect-composer>
                        </model-viewer>
                    </div>
                    <div class="model-info">
                        <div class="model-info-left">
                            <a href="project.html?id=${product.id}" class="model-name">${product.name}</a>
                            <div class="model-specs">
                                <span class="model-materials">${product.medium}</span>
                                <span class="model-dimensions">${product.dimensions}</span>
                            </div>
                        </div>
                        <span class="model-price">$${product.price}</span>
                    </div>
                `;

                grid.appendChild(article);

                const viewer = article.querySelector('model-viewer');
                const pixelateEffect = article.querySelector(`#pixelate-${index}`);

                // Store instance
                PixelateEffect.instances.push({
                    id: index,
                    viewer,
                    pixelateEffect,
                    active: false
                });

                // Watch for materials-ready class (added by model-loader.js after materials applied)
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (viewer.classList.contains('materials-ready')) {
                                // Materials are applied - start pixelate animation
                                console.log(`[EFFECT] Model ${index} materials ready, starting animation`);
                                PixelateEffect.startAnimation(index);
                                observer.disconnect();
                            }
                        }
                    });
                });

                observer.observe(viewer, { attributes: true, attributeFilter: ['class'] });

                // Fallback: if materials-ready is already set
                if (viewer.classList.contains('materials-ready')) {
                    PixelateEffect.startAnimation(index);
                    observer.disconnect();
                }
            });

            console.log(`Loaded ${products.length} products with pixelate effect`);

            // Load models using the existing model-loader
            if (typeof loadProtectedModels === 'function') {
                loadProtectedModels();
            }

        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    // Make loadProductsWithPixelate available globally for reset
    window.loadProductsWithPixelate = loadProductsWithPixelate;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadProductsWithPixelate();

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            PixelateEffect.resetAll();
        });
    });
    </script>
</body>
</html>
